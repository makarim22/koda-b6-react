name: Server CI/CD
run-name: Build and run latest image on server
on: [push]
jobs:
  Build-and-Run:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Setup nodejs v24.13.0
        uses: actions/setup-node@v6
        with:
          node-version: '24.13.0'
      - name: Check nodejs version
        run: node -v
      - name: Gathering source code
        uses: actions/checkout@v6
      - name: Build app
        working-directory: ./my-app
        run: npm install && npm run build
      - name: "[DOCKER] Setup metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/makarim22/frontend-coffee-shop
          tags: |
            type=raw,value=2.0
            type=raw,value=latest
      - name: "[DOCKER] Login GHCR"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner}}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "[DOCKER] Set up QEMU"
        uses: docker/setup-qemu-action@v3
      - name: "[DOCKER] Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3
      - name: "[DOCKER] Build and push"
        uses: docker/build-push-action@v6
        with:
          context: ./my-app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
      - name: "[SERVER] Deploy latest image"
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -e  # Exit on any error
            
            # Pull the latest image
            echo "Pulling latest image..."
            docker pull ghcr.io/makarim22/frontend-coffee-shop:latest
            
            # Stop and remove old container
            echo "Stopping old container..."
            docker stop web-jaka || true
            docker rm -f web-jaka || true
            
            # Run new container
            echo "Starting new container..."
            docker run -d \
              --name web-jaka \
              -p 20000:80 \
              --restart=unless-stopped \
              -e NODE_ENV=production \
              ghcr.io/makarim22/frontend-coffee-shop:latest
            
            # Verify container is running
            if docker ps | grep -q web-jaka; then
              echo "✓ Deployment successful"
            else
              echo "✗ Deployment failed"
              exit 1
            fi
